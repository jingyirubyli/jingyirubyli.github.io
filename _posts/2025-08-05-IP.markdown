---
layout: post
title:  IP
date:   2025-08-05
description: You’ll find this post in your `_posts` directory. Go ahead and edit it and re-build the site to see your changes. # Add post description (optional)
img: nat.png # Add image post (optional)
tags: [Blog, Computer Network]
author: # Add name author (optional)
---
# 本讲内容

NAT(NPAT): 当局域网内的一台电脑想要与互联网中的电脑通信时, 因为局域网内的电脑只有私网ip(不能出现在互联网上), 所以上层路由器将其ip改为公网ip, 同时重新为该连接随机分配一个端口及其与地址的映射关系. 起转发作用.

端口映射: 上面所说连接一旦断开, 中介端口就不再使用. 所以内网电脑只能向外访问, 但是不能接受数据, 因为路由器不会处理. 所以需要在上面基础上分配一个永久的端口, 这样就可以一直连接通信了.

内网穿透: 两个局域网中的两台电脑要连接, 需要一个中介服务器. 中介服务器的带宽会影响信息通信速度. 比起来端口映射就相当于直连.

p2p和打洞: 


NAT打洞: 两个处于不同nat网关的电脑连接, 


## NAT

NAT 全称 Network Address Translation，即网络地址转换，可以理解为公网地址和内网地址的映射规则。从名字看很好理解，就是对数据包的IP地址进行修改；
一个常见的网络数据从网络流量角度来看可以分为五部分：源IP、源端口、协议、目的IP、目的端口；这就是常说的五元组，如果不算协议的话就是四元组，IP通信能正常运行的关键就是这五元组。

> SrcAddr; SrcPort; Protocol; 

NAT 通常是个路由器，且最早是作为 iPv4 地址短缺的一种解决方案而流行起来的。由于公网IPv4地址早已经耗尽，以现在的大众上网的终端数量来看IP地址已经不够用，但现在看起来好像也没受什么影响，这个就得益于一种NAT技术--NAPT也称为PAT，即端口转换。NAPT是一种IP地址复用技术，由于大多数网络流量都基于TCP和UDP，这种传输层协议的寻址使用端口，端口号为1~65535，端口号是充裕的，“复用IP地址”+“改写端口号”是PAT技术的理论基础。

以常见的基于地址和端口转换的 NAPT 为例。如下图所示，假设有台路由器的公网地址为 172.217.194.113 ；此时内网有台地址为 10.0.0.1 的设备想要访问公网服务器，则：

<figure style="text-align: center;">
<img src="/assets/img/nat1.png" alt="NAPT" width="500">
<figcaption>NAPT</figcaption>
</figure>

1. 10.0.0.1 这台设备上端口为 3000 的程序发出源地址为 10.0.0.1:3000 的 IP 数据包。
2. IP 数据包经过路由器时，路由器对其源地址进行查表；如果源地址不在表中，便会自动分配一个端口号给它，图中对应的端口号就是 8080；同时其内网 IP 也会被替换为公网 IP。
3. IP 数据包经过路由器后，源地址变为 172.217.194.113:8080 ，而目标地址不变。

于是 10.0.0.1 这台设备便可以访问公网服务器了。同理，当公网服务器回包时，路由器会进行反向查表，将请求结果转发给 10.0.0.1 这台设备。

## NAT 打洞

打洞